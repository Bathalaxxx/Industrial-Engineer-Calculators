<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Charts Calculator - IE Toolkit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Navigation -->
    <nav class="bg-blue-900 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">IE Toolkit</h1>
            <a href="index.html" class="hover:underline">Home</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto py-8 px-4">
        <section class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-3xl font-semibold mb-4">Control Charts Calculator</h2>
            <p class="text-gray-600 mb-6">Monitor process stability using various control charts (X-Bar and R, X-Bar and S, MR, P, NP, Run Chart) with visualizations and stability analysis.</p>

            <!-- Chart Type Selection -->
            <div class="mb-6">
                <label for="chart-type" class="block text-sm font-medium text-gray-700">Select Chart Type</label>
                <select id="chart-type" class="mt-1 p-2 w-full border rounded-md" onchange="updateInputs()">
                    <option value="xbar-r">X-Bar and R Charts</option>
                    <option value="xbar-s">X-Bar and S Charts</option>
                    <option value="mr">Moving Range (MR) Chart</option>
                    <option value="p">P Chart</option>
                    <option value="np">NP Chart</option>
                    <option value="run">Run Chart</option>
                </select>
            </div>

            <!-- Input Form -->
            <div id="input-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Common Inputs for X-Bar and R/S -->
                <div id="subgroup-inputs" class="hidden">
                    <div>
                        <label for="num-subgroups" class="block text-sm font-medium text-gray-700">Number of Subgroups</label>
                        <input type="number" id="num-subgroups" class="mt-1 p-2 w-full border rounded-md" placeholder="e.g., 20" required oninput="updateDataTable()">
                    </div>
                    <div>
                        <label for="subgroup-size" class="block text-sm font-medium text-gray-700">Subgroup Size</label>
                        <input type="number" id="subgroup-size" class="mt-1 p-2 w-full border rounded-md" placeholder="e.g., 5" required oninput="updateDataTable()">
                    </div>
                </div>
                <!-- Inputs for MR/Run -->
                <div id="individual-inputs" class="hidden">
                    <label for="num-observations" class="block text-sm font-medium text-gray-700">Number of Observations</label>
                    <input type="number" id="num-observations" class="mt-1 p-2 w-full border rounded-md" placeholder="e.g., 30" required oninput="updateDataTable()">
                </div>
                <!-- Inputs for P/NP -->
                <div id="defect-inputs" class="hidden">
                    <label for="num-samples" class="block text-sm font-medium text-gray-700">Number of Samples</label>
                    <input type="number" id="num-samples" class="mt-1 p-2 w-full border rounded-md" placeholder="e.g., 20" required oninput="updateDataTable()">
                    <div id="np-sample-size" class="mt-4 hidden">
                        <label for="sample-size" class="block text-sm font-medium text-gray-700">Sample Size (Fixed)</label>
                        <input type="number" id="sample-size" class="mt-1 p-2 w-full border rounded-md" placeholder="e.g., 100" required>
                    </div>
                </div>
                <!-- Data Input Table -->
                <div id="data-input" class="col-span-1 md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data</label>
                    <div id="data-table" class="overflow-x-auto"></div>
                </div>
            </div>
            <button onclick="calculateControlCharts()" class="mt-6 bg-blue-900 text-white px-4 py-2 rounded-md hover:bg-blue-800">Calculate</button>

            <!-- Results -->
            <div id="results" class="mt-6 hidden">
                <h3 class="text-xl font-semibold mb-2">Results</h3>
                <div id="calculation-results" class="mb-4"></div>
                <div id="chart1-section" class="mb-4">
                    <h4 id="chart1-title" class="text-lg font-semibold"></h4>
                    <canvas id="chart1" class="w-full h-64"></canvas>
                </div>
                <div id="chart2-section" class="mb-4 hidden">
                    <h4 id="chart2-title" class="text-lg font-semibold"></h4>
                    <canvas id="chart2" class="w-full h-64"></canvas>
                </div>
                <div id="interpretation" class="mt-4">
                    <h4 class="text-lg font-semibold">Interpretation</h4>
                    <p id="interpretation-text" class="text-gray-600"></p>
                </div>
                <div id="recommendation" class="mt-4">
                    <h4 class="text-lg font-semibold">Recommendation</h4>
                    <p id="recommendation-text" class="text-gray-600"></p>
                </div>
            </div>
        </section>

        <!-- Control Charts Explanation -->
        <section class="mt-8">
            <h3 class="text-2xl font-semibold mb-4">Control Charts and When to Use Them</h3>
            <div class="space-y-4">
                <div>
                    <h4 class="text-lg font-semibold">X-Bar and R Charts</h4>
                    <p class="text-gray-600">Monitor process mean (subgroup averages) and variability (ranges). Best for small subgroups (2–10).</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold">X-Bar and S Charts</h4>
                    <p class="text-gray-600">Monitor process mean and variability (standard deviations). Preferred for larger subgroups (>10).</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold">Moving Range (MR) Chart</h4>
                    <p class="text-gray-600">Monitors individual measurements and their moving range. Used for single-unit data or when subgrouping is impractical.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold">P Chart</h4>
                    <p class="text-gray-600">Monitors proportion of defective items in variable-sized samples. Used for attribute data (pass/fail).</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold">NP Chart</h4>
                    <p class="text-gray-600">Monitors number of defective items in fixed-sized samples. Used for attribute data with constant sample size.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold">Run Chart</h4>
                    <p class="text-gray-600">Plots individual measurements over time to identify trends or shifts. No control limits; used for initial process analysis.</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-blue-900 text-white text-center p-4">
        <p>&copy; 2025 IE Toolkit. All rights reserved.</p>
    </footer>

    <script>
        let chart1Instance = null;
        let chart2Instance = null;

        function updateInputs() {
            const chartType = document.getElementById('chart-type').value;
            document.getElementById('subgroup-inputs').classList.add('hidden');
            document.getElementById('individual-inputs').classList.add('hidden');
            document.getElementById('defect-inputs').classList.add('hidden');
            document.getElementById('np-sample-size').classList.add('hidden');
            document.getElementById('data-table').innerHTML = '';
            document.getElementById('results').classList.add('hidden');

            if (chartType === 'xbar-r' || chartType === 'xbar-s') {
                document.getElementById('subgroup-inputs').classList.remove('hidden');
            } else if (chartType === 'mr' || chartType === 'run') {
                document.getElementById('individual-inputs').classList.remove('hidden');
            } else if (chartType === 'p' || chartType === 'np') {
                document.getElementById('defect-inputs').classList.remove('hidden');
                if (chartType === 'np') {
                    document.getElementById('np-sample-size').classList.remove('hidden');
                }
            }
            updateDataTable();
        }

        function updateDataTable() {
            const chartType = document.getElementById('chart-type').value;
            const dataTable = document.getElementById('data-table');
            let tableHTML = '';

            if (chartType === 'xbar-r' || chartType === 'xbar-s') {
                const numSubgroups = parseInt(document.getElementById('num-subgroups').value) || 0;
                const subgroupSize = parseInt(document.getElementById('subgroup-size').value) || 0;
                if (numSubgroups <= 0 || subgroupSize <= 0) {
                    dataTable.innerHTML = '';
                    return;
                }
                tableHTML = '<table class="w-full border-collapse border border-gray-300"><thead><tr class="bg-gray-100"><th class="border border-gray-300 p-2">Subgroup</th>';
                for (let i = 1; i <= subgroupSize; i++) {
                    tableHTML += `<th class="border border-gray-300 p-2">Sample ${i}</th>`;
                }
                tableHTML += '</tr></thead><tbody>';
                for (let subgroup = 1; subgroup <= numSubgroups; subgroup++) {
                    tableHTML += `<tr><td class="border border-gray-300 p-2">Subgroup ${subgroup}</td>`;
                    for (let sample = 1; sample <= subgroupSize; sample++) {
                        tableHTML += `<td class="border border-gray-300 p-2"><input type="number" id="data-${subgroup}-${sample}" class="p-1 w-full border rounded-md" placeholder="e.g., 15"></td>`;
                    }
                    tableHTML += '</tr>';
                }
                tableHTML += '</tbody></table>';
            } else if (chartType === 'mr' || chartType === 'run') {
                const numObservations = parseInt(document.getElementById('num-observations').value) || 0;
                if (numObservations <= 0) {
                    dataTable.innerHTML = '';
                    return;
                }
                tableHTML = '<table class="w-full border-collapse border border-gray-300"><thead><tr class="bg-gray-100"><th class="border border-gray-300 p-2">Observation</th><th class="border border-gray-300 p-2">Value</th></tr></thead><tbody>';
                for (let i = 1; i <= numObservations; i++) {
                    tableHTML += `<tr><td class="border border-gray-300 p-2">${i}</td><td class="border border-gray-300 p-2"><input type="number" id="data-${i}" class="p-1 w-full border rounded-md" placeholder="e.g., 15"></td></tr>`;
                }
                tableHTML += '</tbody></table>';
            } else if (chartType === 'p' || chartType === 'np') {
                const numSamples = parseInt(document.getElementById('num-samples').value) || 0;
                const isPChart = chartType === 'p';
                tableHTML = '<table class="w-full border-collapse border border-gray-300"><thead><tr class="bg-gray-100"><th class="border border-gray-300 p-2">Sample</th><th class="border border-gray-300 p-2">Defectives</th>' + (isPChart ? '<th class="border border-gray-300 p-2">Sample Size</th>' : '') + '</tr></thead><tbody>';
                for (let i = 1; i <= numSamples; i++) {
                    tableHTML += `<tr><td class="border border-gray-300 p-2">${i}</td><td class="border border-gray-300 p-2"><input type="number" id="defectives-${i}" class="p-1 w-full border rounded-md" placeholder="e.g., 5"></td>`;
                    if (isPChart) {
                        tableHTML += `<td class="border border-gray-300 p-2"><input type="number" id="sample-size-${i}" class="p-1 w-full border rounded-md" placeholder="e.g., 100"></td>`;
                    }
                    tableHTML += '</tr>';
                }
                tableHTML += '</tbody></table>';
            }
            dataTable.innerHTML = tableHTML;
        }

        function calculateControlCharts() {
            const chartType = document.getElementById('chart-type').value;
            let results = '', interpretation = '', recommendation = '';
            let chart1Data, chart1UCL, chart1LCL, chart1Center, chart1Label, chart1OutOfControl;
            let chart2Data, chart2UCL, chart2LCL, chart2Center, chart2Label, chart2OutOfControl;

            // Control chart constants
            const controlConstants = {
                2: { A2: 1.880, D3: 0, D4: 3.267, A3: 2.659, B3: 0, B4: 3.267, E2: 2.660 },
                3: { A2: 1.023, D3: 0, D4: 2.575, A3: 1.954, B3: 0, B4: 2.568, E2: 1.772 },
                4: { A2: 0.729, D3: 0, D4: 2.282, A3: 1.628, B3: 0, B4: 2.266, E2: 1.457 },
                5: { A2: 0.577, D3: 0, D4: 2.114, A3: 1.427, B3: 0, B4: 2.089, E2: 1.290 },
                6: { A2: 0.483, D3: 0, D4: 2.004, A3: 1.287, B3: 0.030, B4: 1.970, E2: 1.184 },
                7: { A2: 0.419, D3: 0.076, D4: 1.924, A3: 1.182, B3: 0.118, B4: 1.882, E2: 1.099 },
                8: { A2: 0.373, D3: 0.136, D4: 1.864, A3: 1.099, B3: 0.185, B4: 1.815, E2: 1.032 },
                9: { A2: 0.337, D3: 0.184, D4: 1.816, A3: 1.032, B3: 0.239, B4: 1.761, E2: 0.975 },
                10: { A2: 0.308, D3: 0.223, D4: 1.777, A3: 0.975, B3: 0.284, B4: 1.716, E2: 0.927 },
                11: { A3: 0.927, B3: 0.321, B4: 1.679 },
                12: { A3: 0.886, B3: 0.354, B4: 1.646 },
                13: { A3: 0.850, B3: 0.382, B4: 1.618 },
                14: { A3: 0.817, B3: 0.406, B4: 1.594 },
                15: { A3: 0.789, B3: 0.428, B4: 1.572 }
            };

            if (chartType === 'xbar-r' || chartType === 'xbar-s') {
                const numSubgroups = parseInt(document.getElementById('num-subgroups').value);
                const subgroupSize = parseInt(document.getElementById('subgroup-size').value);
                if (isNaN(numSubgroups) || isNaN(subgroupSize) || numSubgroups <= 0 || subgroupSize <= 0) {
                    alert('Please enter valid positive numbers for number of subgroups and subgroup size.');
                    return;
                }
                if (!controlConstants[subgroupSize] || (chartType === 'xbar-r' && subgroupSize > 10)) {
                    alert(`Subgroup size must be between 2 and ${chartType === 'xbar-r' ? 10 : 15}.`);
                    return;
                }

                // Collect subgroup data
                const data = [];
                let allValid = true;
                for (let subgroup = 1; subgroup <= numSubgroups; subgroup++) {
                    const subgroupData = [];
                    for (let sample = 1; sample <= subgroupSize; sample++) {
                        const value = parseFloat(document.getElementById(`data-${subgroup}-${sample}`).value);
                        if (isNaN(value)) {
                            allValid = false;
                            break;
                        }
                        subgroupData.push(value);
                    }
                    if (!allValid) break;
                    data.push(subgroupData);
                }
                if (!allValid) {
                    alert('Please enter valid measurement data for all subgroups and samples.');
                    return;
                }

                // X-Bar calculations
                const subgroupMeans = data.map(subgroup => subgroup.reduce((sum, x) => sum + x, 0) / subgroupSize);
                const grandMean = subgroupMeans.reduce((sum, x) => sum + x, 0) / numSubgroups;
                chart1Data = subgroupMeans;
                chart1Center = grandMean;
                chart1Label = 'Subgroup Mean';
                let variabilityValues, averageVariability, variabilityLabel;

                if (chartType === 'xbar-r') {
                    // R Chart calculations
                    variabilityValues = data.map(subgroup => Math.max(...subgroup) - Math.min(...subgroup));
                    averageVariability = variabilityValues.reduce((sum, x) => sum + x, 0) / numSubgroups;
                    const { A2, D3, D4 } = controlConstants[subgroupSize];
                    chart1UCL = grandMean + A2 * averageVariability;
                    chart1LCL = grandMean - A2 * averageVariability;
                    chart2UCL = D4 * averageVariability;
                    chart2LCL = D3 * averageVariability;
                    chart2Data = variabilityValues;
                    chart2Center = averageVariability;
                    chart2Label = 'Subgroup Range';
                    variabilityLabel = 'Range';

                    // Results table
                    results = '<table class="w-full border-collapse border border-gray-300"><thead><tr class="bg-gray-100"><th class="border border-gray-300 p-2">Subgroup</th><th class="border border-gray-300 p-2">Mean</th><th class="border border-gray-300 p-2">Range</th></tr></thead><tbody>';
                    subgroupMeans.forEach((mean, i) => {
                        results += `<tr><td class="border border-gray-300 p-2">${i + 1}</td><td class="border border-gray-300 p-2">${mean.toFixed(2)}</td><td class="border border-gray-300 p-2">${variabilityValues[i].toFixed(2)}</td></tr>`;
                    });
                    results += '</tbody></table>';
                    results = `
                        <p><strong>X-Bar Chart</strong></p>
                        <p>Centerline (Grand Mean): ${grandMean.toFixed(2)}</p>
                        <p>Upper Control Limit (UCL): ${chart1UCL.toFixed(2)}</p>
                        <p>Lower Control Limit (LCL): ${chart1LCL.toFixed(2)}</p>
                        <p><strong>R Chart</strong></p>
                        <p>Centerline (Average Range): ${averageVariability.toFixed(2)}</p>
                        <p>Upper Control Limit (UCL): ${chart2UCL.toFixed(2)}</p>
                        <p>Lower Control Limit (LCL): ${chart2LCL.toFixed(2)}</p>
                        ${results}
                    `;
                } else {
                    // S Chart calculations
                    variabilityValues = data.map(subgroup => {
                        const mean = subgroup.reduce((sum, x) => sum + x, 0) / subgroupSize;
                        return Math.sqrt(subgroup.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / (subgroupSize - 1));
                    });
                    averageVariability = variabilityValues.reduce((sum, x) => sum + x, 0) / numSubgroups;
                    const { A3, B3, B4 } = controlConstants[subgroupSize];
                    chart1UCL = grandMean + A3 * averageVariability;
                    chart1LCL = grandMean - A3 * averageVariability;
                    chart2UCL = B4 * averageVariability;
                    chart2LCL = B3 * averageVariability;
                    chart2Data = variabilityValues;
                    chart2Center = averageVariability;
                    chart2Label = 'Subgroup Standard Deviation';
                    variabilityLabel = 'Standard Deviation';

                    // Results table
                    results = '<table class="w-full border-collapse border border-gray-300"><thead><tr class="bg-gray-100"><th class="border border-gray-300 p-2">Subgroup</th><th class="border border-gray-300 p-2">Mean</th><th class="border border-gray-300 p-2">Standard Deviation</th></tr></thead><tbody>';
                    subgroupMeans.forEach((mean, i) => {
                        results += `<tr><td class="border border-gray-300 p-2">${i + 1}</td><td class="border border-gray-300 p-2">${mean.toFixed(2)}</td><td class="border border-gray-300 p-2">${variabilityValues[i].toFixed(2)}</td></tr>`;
                    });
                    results += '</tbody></table>';
                    results = `
                        <p><strong>X-Bar Chart</strong></p>
                        <p>Centerline (Grand Mean): ${grandMean.toFixed(2)}</p>
                        <p>Upper Control Limit (UCL): ${chart1UCL.toFixed(2)}</p>
                        <p>Lower Control Limit (LCL): ${chart1LCL.toFixed(2)}</p>
                        <p><strong>S Chart</strong></p>
                        <p>Centerline (Average Std Dev): ${averageVariability.toFixed(2)}</p>
                        <p>Upper Control Limit (UCL): ${chart2UCL.toFixed(2)}</p>
                        <p>Lower Control Limit (LCL): ${chart2LCL.toFixed(2)}</p>
                        ${results}
                    `;
                }

                chart1OutOfControl = subgroupMeans.map((mean, i) => mean > chart1UCL || mean < chart1LCL ? i + 1 : null).filter(x => x);
                chart2OutOfControl = variabilityValues.map((value, i) => value > chart2UCL || value < chart2LCL ? i + 1 : null).filter(x => x);
                interpretation = `The X-Bar Chart monitors the process mean (centerline = ${grandMean.toFixed(2)}), with control limits at ${chart1LCL.toFixed(2)} and ${chart1UCL.toFixed(2)}. The ${chartType === 'xbar-r' ? 'R Chart' : 'S Chart'} monitors process variability (centerline = ${averageVariability.toFixed(2)}), with control limits at ${chart2LCL.toFixed(2)} and ${chart2UCL.toFixed(2)}. ${chart1OutOfControl.length > 0 ? `Out-of-control points detected on X-Bar Chart at subgroups: ${chart1OutOfControl.join(', ')}.` : 'No out-of-control points on X-Bar Chart.'} ${chart2OutOfControl.length > 0 ? `Out-of-control points detected on ${chartType === 'xbar-r' ? 'R Chart' : 'S Chart'} at subgroups: ${chart2OutOfControl.join(', ')}.` : `No out-of-control points on ${chartType === 'xbar-r' ? 'R Chart' : 'S Chart'}.`}`;
                recommendation = `${chart1OutOfControl.length > 0 || chart2OutOfControl.length > 0 ? `The process shows signs of instability. Investigate out-of-control subgroups for special causes (e.g., equipment issues, operator errors, material changes). For X-Bar Chart issues, check for mean shifts. For ${chartType === 'xbar-r' ? 'R Chart' : 'S Chart'} issues, address variability.` : 'The process appears stable, with all points within control limits. Continue monitoring.'}`;
            } else if (chartType === 'mr') {
                const numObservations = parseInt(document.getElementById('num-observations').value);
                if (isNaN(numObservations) || numObservations <= 0) {
                    alert('Please enter a valid positive number for observations.');
                    return;
                }
                const data = [];
                let allValid = true;
                for (let i = 1; i <= numObservations; i++) {
                    const value = parseFloat(document.getElementById(`data-${i}`).value);
                    if (isNaN(value)) {
                        allValid = false;
                        break;
                    }
                    data.push(value);
                }
                if (!allValid) {
                    alert('Please enter valid measurement data for all observations.');
                    return;
                }

                // MR calculations
                const movingRanges = [];
                for (let i = 1; i < numObservations; i++) {
                    movingRanges.push(Math.abs(data[i] - data[i - 1]));
                }
                const averageMR = movingRanges.reduce((sum, x) => sum + x, 0) / movingRanges.length;
                const averageX = data.reduce((sum, x) => sum + x, 0) / numObservations;
                const E2 = controlConstants[2].E2; // MR uses subgroup size 2
                chart1Data = data;
                chart1Center = averageX;
                chart1UCL = averageX + E2 * averageMR;
                chart1LCL = averageX - E2 * averageMR;
                chart1Label = 'Individual Value';
                chart2Data = movingRanges;
                chart2Center = averageMR;
                chart2UCL = controlConstants[2].D4 * averageMR;
                chart2LCL = controlConstants[2].D3 * averageMR;
                chart2Label = 'Moving Range';

                // Results table
                results = '<table class="w-full border-collapse border border-gray-300"><thead><tr class="bg-gray-100"><th class="border border-gray-300 p-2">Observation</th><th class="border border-gray-300 p-2">Value</th><th class="border border-gray-300 p-2">Moving Range</th></tr></thead><tbody>';
                data.forEach((value, i) => {
                    results += `<tr><td class="border border-gray-300 p-2">${i + 1}</td><td class="border border-gray-300 p-2">${value.toFixed(2)}</td><td class="border border-gray-300 p-2">${i === 0 ? '-' : movingRanges[i - 1].toFixed(2)}</td></tr>`;
                });
                results += '</tbody></table>';
                results = `
                    <p><strong>Individuals Chart</strong></p>
                    <p>Centerline (Average): ${averageX.toFixed(2)}</p>
                    <p>Upper Control Limit (UCL): ${chart1UCL.toFixed(2)}</p>
                    <p>Lower Control Limit (LCL): ${chart1LCL.toFixed(2)}</p>
                    <p><strong>Moving Range Chart</strong></p>
                    <p>Centerline (Average MR): ${averageMR.toFixed(2)}</p>
                    <p>Upper Control Limit (UCL): ${chart2UCL.toFixed(2)}</p>
                    <p>Lower Control Limit (LCL): ${chart2LCL.toFixed(2)}</p>
                    ${results}
                `;
                chart1OutOfControl = data.map((value, i) => value > chart1UCL || value < chart1LCL ? i + 1 : null).filter(x => x);
                chart2OutOfControl = movingRanges.map((value, i) => value > chart2UCL || value < chart2LCL ? i + 1 : null).filter(x => x);
                interpretation = `The Individuals Chart monitors individual values (centerline = ${averageX.toFixed(2)}), with control limits at ${chart1LCL.toFixed(2)} and ${chart1UCL.toFixed(2)}. The Moving Range Chart monitors variability (centerline = ${averageMR.toFixed(2)}), with control limits at ${chart2LCL.toFixed(2)} and ${chart2UCL.toFixed(2)}. ${chart1OutOfControl.length > 0 ? `Out-of-control points detected on Individuals Chart at observations: ${chart1OutOfControl.join(', ')}.` : 'No out-of-control points on Individuals Chart.'} ${chart2OutOfControl.length > 0 ? `Out-of-control points detected on MR Chart at observations: ${chart2OutOfControl.join(', ')}.` : 'No out-of-control points on MR Chart.'}`;
                recommendation = `${chart1OutOfControl.length > 0 || chart2OutOfControl.length > 0 ? 'The process shows signs of instability. Investigate out-of-control observations for special causes (e.g., measurement errors, process changes). For Individuals Chart issues, check for shifts in values. For MR Chart issues, address variability.' : 'The process appears stable, with all points within control limits. Continue monitoring.'}`;
            } else if (chartType === 'p' || chartType === 'np') {
                const numSamples = parseInt(document.getElementById('num-samples').value);
                if (isNaN(numSamples) || numSamples <= 0) {
                    alert('Please enter a valid positive number for samples.');
                    return;
                }
                const isPChart = chartType === 'p';
                let sampleSizes = [];
                if (isPChart) {
                    sampleSizes = Array.from({ length: numSamples }, (_, i) => parseInt(document.getElementById(`sample-size-${i + 1}`).value));
                    if (sampleSizes.some(size => isNaN(size) || size <= 0)) {
                        alert('Please enter valid positive sample sizes.');
                        return;
                    }
                } else {
                    const fixedSampleSize = parseInt(document.getElementById('sample-size').value);
                    if (isNaN(fixedSampleSize) || fixedSampleSize <= 0) {
                        alert('Please enter a valid positive sample size.');
                        return;
                    }
                    sampleSizes = Array(numSamples).fill(fixedSampleSize);
                }
                const defectives = Array.from({ length: numSamples }, (_, i) => parseInt(document.getElementById(`defectives-${i + 1}`).value));
                if (defectives.some(d => isNaN(d) || d < 0 || d > sampleSizes[i])) {
                    alert('Please enter valid non-negative defectives (≤ sample size).');
                    return;
                }

                // P or NP calculations
                if (isPChart) {
                    const proportions = defectives.map((d, i) => d / sampleSizes[i]);
                    const averageP = defectives.reduce((sum, d, i) => sum + d / sampleSizes[i], 0) / numSamples;
                    chart1Data = proportions;
                    chart1Center = averageP;
                    chart1UCL = proportions.map((_, i) => averageP + 3 * Math.sqrt(averageP * (1 - averageP) / sampleSizes[i]));
                    chart1LCL = proportions.map((_, i) => Math.max(0, averageP - 3 * Math.sqrt(averageP * (1 - averageP) / sampleSizes[i])));
                    chart1Label = 'Proportion Defective';
                    chart1OutOfControl = proportions.map((p, i) => p > chart1UCL[i] || p < chart1LCL[i] ? i + 1 : null).filter(x => x);

                    // Results table
                    results = '<table class="w-full border-collapse border border-gray-300"><thead><tr class="bg-gray-100"><th class="border border-gray-300 p-2">Sample</th><th class="border border-gray-300 p-2">Defectives</th><th class="border border-gray-300 p-2">Sample Size</th><th class="border border-gray-300 p-2">Proportion</th></tr></thead><tbody>';
                    proportions.forEach((p, i) => {
                        results += `<tr><td class="border border-gray-300 p-2">${i + 1}</td><td class="border border-gray-300 p-2">${defectives[i]}</td><td class="border border-gray-300 p-2">${sampleSizes[i]}</td><td class="border border-gray-300 p-2">${p.toFixed(4)}</td></tr>`;
                    });
                    results += '</tbody></table>';
                    results = `
                        <p><strong>P Chart</strong></p>
                        <p>Centerline (Average Proportion): ${averageP.toFixed(4)}</p>
                        <p>Control limits vary by sample size.</p>
                        ${results}
                    `;
                    interpretation = `The P Chart monitors the proportion of defectives (centerline = ${averageP.toFixed(4)}), with control limits varying by sample size. ${chart1OutOfControl.length > 0 ? `Out-of-control points detected at samples: ${chart1OutOfControl.join(', ')}.` : 'No out-of-control points on P Chart.'}`;
                    recommendation = `${chart1OutOfControl.length > 0 ? 'The process shows signs of instability. Investigate out-of-control samples for special causes (e.g., changes in defect rates, inspection issues). Address factors increasing defect proportions.' : 'The process appears stable, with all points within control limits. Continue monitoring.'}`;
                } else {
                    const npValues = defectives;
                    const averageNP = defectives.reduce((sum, d) => sum + d, 0) / numSamples;
                    chart1Data = npValues;
                    chart1Center = averageNP;
                    chart1UCL = averageNP + 3 * Math.sqrt(averageNP * (1 - averageNP / sampleSizes[0]));
                    chart1LCL = Math.max(0, averageNP - 3 * Math.sqrt(averageNP * (1 - averageNP / sampleSizes[0])));
                    chart1Label = 'Number of Defectives';
                    chart1OutOfControl = npValues.map((np, i) => np > chart1UCL || np < chart1LCL ? i + 1 : null).filter(x => x);

                    // Results table
                    results = '<table class="w-full border-collapse border border-gray-300"><thead><tr class="bg-gray-100"><th class="border border-gray-300 p-2">Sample</th><th class="border border-gray-300 p-2">Defectives</th></tr></thead><tbody>';
                    npValues.forEach((np, i) => {
                        results += `<tr><td class="border border-gray-300 p-2">${i + 1}</td><td class="border border-gray-300 p-2">${np}</td></tr>`;
                    });
                    results += '</tbody></table>';
                    results = `
                        <p><strong>NP Chart</strong></p>
                        <p>Centerline (Average Defectives): ${averageNP.toFixed(2)}</p>
                        <p>Upper Control Limit (UCL): ${chart1UCL.toFixed(2)}</p>
                        <p>Lower Control Limit (LCL): ${chart1LCL.toFixed(2)}</p>
                        ${results}
                    `;
                    interpretation = `The NP Chart monitors the number of defectives (centerline = ${averageNP.toFixed(2)}), with control limits at ${chart1LCL.toFixed(2)} and ${chart1UCL.toFixed(2)}. ${chart1OutOfControl.length > 0 ? `Out-of-control points detected at samples: ${chart1OutOfControl.join(', ')}.` : 'No out-of-control points on NP Chart.'}`;
                    recommendation = `${chart1OutOfControl.length > 0 ? 'The process shows signs of instability. Investigate out-of-control samples for special causes (e.g., changes in defect rates, inspection issues). Address factors increasing defect counts.' : 'The process appears stable, with all points within control limits. Continue monitoring.'}`;
                }
            } else if (chartType === 'run') {
                const numObservations = parseInt(document.getElementById('num-observations').value);
                if (isNaN(numObservations) || numObservations <= 0) {
                    alert('Please enter a valid positive number for observations.');
                    return;
                }
                const data = [];
                let allValid = true;
                for (let i = 1; i <= numObservations; i++) {
                    const value = parseFloat(document.getElementById(`data-${i}`).value);
                    if (isNaN(value)) {
                        allValid = false;
                        break;
                    }
                    data.push(value);
                }
                if (!allValid) {
                    alert('Please enter valid measurement data for all observations.');
                    return;
                }

                // Run Chart calculations (median for centerline, no control limits)
                const sortedData = [...data].sort((a, b) => a - b);
                const median = numObservations % 2 === 0 ? (sortedData[numObservations / 2 - 1] + sortedData[numObservations / 2]) / 2 : sortedData[Math.floor(numObservations / 2)];
                chart1Data = data;
                chart1Center = median;
                chart1UCL = null;
                chart1LCL = null;
                chart1Label = 'Observation Value';
                chart2Data = null;

                // Simple trend analysis
                let runs = 1;
                let aboveMedian = data[0] > median;
                for (let i = 1; i < numObservations; i++) {
                    const currentAbove = data[i] > median;
                    if (currentAbove !== aboveMedian) {
                        runs++;
                        aboveMedian = currentAbove;
                    }
                }
                const expectedRuns = (numObservations + 1) / 2;
                const hasTrends = runs < expectedRuns * 0.5 || runs > expectedRuns * 1.5;

                // Results table
                results = '<table class="w-full border-collapse border border-gray-300"><thead><tr class="bg-gray-100"><th class="border border-gray-300 p-2">Observation</th><th class="border border-gray-300 p-2">Value</th></tr></thead><tbody>';
                data.forEach((value, i) => {
                    results += `<tr><td class="border border-gray-300 p-2">${i + 1}</td><td class="border border-gray-300 p-2">${value.toFixed(2)}</td></tr>`;
                });
                results += '</tbody></table>';
                results = `
                    <p><strong>Run Chart</strong></p>
                    <p>Centerline (Median): ${median.toFixed(2)}</p>
                    ${results}
                `;
                interpretation = `The Run Chart plots individual observations with a centerline at the median (${median.toFixed(2)}). No control limits are used. ${hasTrends ? `Potential trends or shifts detected (observed runs: ${runs}, expected: ~${expectedRuns.toFixed(1)}).` : 'No obvious trends or shifts detected.'}`;
                recommendation = `${hasTrends ? 'Investigate potential trends or shifts in the process, which may indicate non-random variation (e.g., process changes, external factors). Consider using a control chart for further analysis.' : 'The process shows no obvious trends. Consider using a control chart to monitor stability with control limits.'}`;
            }

            // Render Chart 1
            if (chart1Instance) chart1Instance.destroy();
            const chart1Ctx = document.getElementById('chart1').getContext('2d');
            const chart1Datasets = [
                {
                    label: chart1Label,
                    data: chart1Data,
                    borderColor: 'rgba(59, 130, 246, 1)',
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    pointRadius: 5,
                    pointBackgroundColor: chart1UCL ? chart1Data.map((value, i) => value > (chart1UCL[i] || chart1UCL) || value < (chart1LCL[i] || chart1LCL) ? 'rgba(255, 99, 132, 1)' : 'rgba(59, 130, 246, 1)') : chart1Data.map(() => 'rgba(59, 130, 246, 1)'),
                    tension: chartType === 'run' ? 0 : 0.1,
                    fill: false
                },
                {
                    label: 'Centerline',
                    data: Array(chart1Data.length).fill(chart1Center),
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderDash: [5, 5],
                    pointRadius: 0
                }
            ];
            if (chart1UCL) {
                chart1Datasets.push(
                    {
                        label: 'UCL',
                        data: Array.isArray(chart1UCL) ? chart1UCL : Array(chart1Data.length).fill(chart1UCL),
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderDash: [5, 5],
                        pointRadius: 0
                    },
                    {
                        label: 'LCL',
                        data: Array.isArray(chart1LCL) ? chart1LCL : Array(chart1Data.length).fill(chart1LCL),
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderDash: [5, 5],
                        pointRadius: 0
                    }
                );
            }
            chart1Instance = new Chart(chart1Ctx, {
                type: chartType === 'run' ? 'scatter' : 'line',
                data: {
                    labels: Array.from({ length: chart1Data.length }, (_, i) => i + 1),
                    datasets: chart1Datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            title: { display: true, text: chart1Label },
                            suggestedMin: chart1LCL ? Math.min(...(Array.isArray(chart1LCL) ? chart1LCL : [chart1LCL]), ...chart1Data) * 0.95 : Math.min(...chart1Data) * 0.95,
                            suggestedMax: chart1UCL ? Math.max(...(Array.isArray(chart1UCL) ? chart1UCL : [chart1UCL]), ...chart1Data) * 1.05 : Math.max(...chart1Data) * 1.05
                        },
                        x: {
                            title: { display: true, text: chartType === 'xbar-r' || chartType === 'xbar-s' ? 'Subgroup' : 'Observation/Sample' }
                        }
                    },
                    plugins: {
                        legend: { display: true },
                        title: { display: true, text: chartType === 'xbar-r' || chartType === 'xbar-s' ? 'X-Bar Control Chart' : chartType === 'mr' ? 'Individuals Control Chart' : chartType === 'p' ? 'P Control Chart' : chartType === 'np' ? 'NP Control Chart' : 'Run Chart' }
                    }
                }
            });

            // Render Chart 2 (if applicable)
            document.getElementById('chart2-section').classList.toggle('hidden', !chart2Data);
            if (chart2Data) {
                if (chart2Instance) chart2Instance.destroy();
                const chart2Ctx = document.getElementById('chart2').getContext('2d');
                chart2Instance = new Chart(chart2Ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({ length: chart2Data.length }, (_, i) => i + 1),
                        datasets: [
                            {
                                label: chart2Label,
                                data: chart2Data,
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                pointRadius: 5,
                                pointBackgroundColor: chart2Data.map((value, i) => value > chart2UCL || value < chart2LCL ? 'rgba(255, 99, 132, 1)' : 'rgba(59, 130, 246, 1)'),
                                tension: 0.1
                            },
                            {
                                label: 'Centerline',
                                data: Array(chart2Data.length).fill(chart2Center),
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderDash: [5, 5],
                                pointRadius: 0
                            },
                            {
                                label: 'UCL',
                                data: Array(chart2Data.length).fill(chart2UCL),
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderDash: [5, 5],
                                pointRadius: 0
                            },
                            {
                                label: 'LCL',
                                data: Array(chart2Data.length).fill(chart2LCL),
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderDash: [5, 5],
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                title: { display: true, text: chart2Label },
                                suggestedMin: Math.max(0, chart2LCL * 0.95),
                                suggestedMax: Math.max(...chart2Data, chart2UCL) * 1.05
                            },
                            x: {
                                title: { display: true, text: 'Subgroup/Observation' }
                            }
                        },
                        plugins: {
                            legend: { display: true },
                            title: { display: true, text: chartType === 'xbar-r' ? 'R Control Chart' : chartType === 'xbar-s' ? 'S Control Chart' : 'Moving Range Chart' }
                        }
                    }
                });
            }

            document.getElementById('chart1-title').innerText = chartType === 'xbar-r' || chartType === 'xbar-s' ? 'X-Bar Chart' : chartType === 'mr' ? 'Individuals Chart' : chartType === 'p' ? 'P Chart' : chartType === 'np' ? 'NP Chart' : 'Run Chart';
            document.getElementById('chart2-title').innerText = chartType === 'xbar-r' ? 'R Chart' : chartType === 'xbar-s' ? 'S Chart' : 'Moving Range Chart';
            document.getElementById('calculation-results').innerHTML = results;
            document.getElementById('interpretation-text').innerText = interpretation;
            document.getElementById('recommendation-text').innerText = recommendation;
            document.getElementById('results').classList.remove('hidden');
        }
    </script>
</body>
</html>
